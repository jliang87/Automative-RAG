import os
import streamlit as st
import httpx
from typing import Dict, List, Optional, Union

# å¯¼å…¥ç»Ÿä¸€çš„ API å®¢æˆ·ç«¯
from src.ui.api_client import api_request
from src.ui.components import header

# å¯¼å…¥å¢å¼ºç»„ä»¶
from src.ui.system_notifications import display_notifications_sidebar
from src.ui.enhanced_error_handling import robust_api_status_indicator, handle_worker_dependency

# é…ç½®åº”ç”¨
st.set_page_config(
   page_title="æ±½è½¦è§„æ ¼ RAG ç³»ç»Ÿ",
   page_icon="ğŸš—",
   layout="wide",
   initial_sidebar_state="expanded",
)

# API é…ç½®
API_URL = os.environ.get("API_URL", "http://localhost:8000")
API_KEY = os.environ.get("API_KEY", "default-api-key")

# ä¼šè¯çŠ¶æ€åˆå§‹åŒ–
if "api_url" not in st.session_state:
   st.session_state.api_url = API_URL
if "api_key" not in st.session_state:
   st.session_state.api_key = API_KEY
if "authenticated" not in st.session_state:
   st.session_state.authenticated = False
if "system_notifications" not in st.session_state:
   st.session_state.system_notifications = []
if "last_notification_check" not in st.session_state:
   st.session_state.last_notification_check = 0

# åœ¨ä¾§è¾¹æ æ˜¾ç¤ºé€šçŸ¥
display_notifications_sidebar(st.session_state.api_url, st.session_state.api_key)

# ä½¿ç”¨å¢å¼ºçš„ API çŠ¶æ€æŒ‡ç¤ºå™¨ä»£æ›¿ç®€å•çš„çŠ¶æ€æ£€æŸ¥
with st.sidebar:
   api_available = robust_api_status_indicator(show_detail=True)

# ä»…åœ¨ API å¯ç”¨æ—¶æ˜¾ç¤ºä¸»è¦å†…å®¹
if api_available:
   header(
       "æ±½è½¦è§„æ ¼ RAG ç³»ç»Ÿ",
       "ä¸€ä¸ªåŸºäº GPU åŠ é€Ÿçš„ç³»ç»Ÿï¼Œç”¨äºä½¿ç”¨å»¶è¿Ÿäº¤äº’æ£€ç´¢ (Late Interaction Retrieval) å’Œæ··åˆé‡æ’åºè¿›è¡Œæ±½è½¦è§„æ ¼ä¿¡æ¯æ£€ç´¢ã€‚"
   )

# ç³»ç»Ÿæ¦‚è¿°
st.markdown("""
## å…³äºç³»ç»Ÿ

è¯¥ç³»ç»Ÿé‡‡ç”¨æœ€å…ˆè¿›çš„æ£€ç´¢å¢å¼ºç”Ÿæˆ (RAG) æŠ€æœ¯ï¼Œæä¾›ç²¾ç¡®çš„æ±½è½¦è§„æ ¼ä¿¡æ¯ã€‚ä¸»è¦ç‰¹æ€§åŒ…æ‹¬ï¼š

- **å¤šè¯­è¨€æ”¯æŒ**ï¼šä½¿ç”¨ BAAI/bge-m3 åµŒå…¥æ¨¡å‹ï¼ŒåŒæ—¶æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡å†…å®¹
- **ä¸¤é˜¶æ®µæ··åˆé‡æ’åº**ï¼šç»“åˆ ColBERT å’Œ BGE-Reranker-Large å®ç°é«˜è´¨é‡æ£€ç´¢
 - ColBERT æä¾›ä»¤ç‰Œçº§åˆ«çš„ç²¾ç¡®äº¤äº’åˆ†æï¼ˆå æ¯” 80%ï¼‰
 - BGE-Reranker å¢å¼ºåŒè¯­ç†è§£èƒ½åŠ›ï¼ˆå æ¯” 20%ï¼‰
- **å»¶è¿Ÿäº¤äº’æ£€ç´¢**ï¼ˆColBERTï¼‰å®ç°æ›´ç²¾å‡†çš„è¯­ä¹‰åŒ¹é…
- **æœ¬åœ° DeepSeek LLM** æä¾›æ—  API ä¾èµ–çš„ç­”æ¡ˆç”Ÿæˆ
- **ç»Ÿä¸€è§†é¢‘å¤„ç†**ï¼šä½¿ç”¨ Whisper AI é«˜è´¨é‡è½¬å½• YouTubeã€Bilibili ç­‰å¹³å°è§†é¢‘
- **å…¨ GPU åŠ é€Ÿ**ï¼Œæ”¯æŒè½¬å½•ã€OCRã€åµŒå…¥å’Œæ¨ç†è®¡ç®—
- **æ··åˆæœç´¢** ç»“åˆå‘é‡ç›¸ä¼¼åº¦å’Œå…ƒæ•°æ®ç­›é€‰
- **åŒè¯­ OCR**ï¼šæ”¯æŒè‹±æ–‡å’Œç®€ä½“ä¸­æ–‡æ–‡æ¡£çš„å…‰å­¦å­—ç¬¦è¯†åˆ«
- **åå°å¤„ç†ç³»ç»Ÿ**ï¼šèµ„æºå¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚è§†é¢‘è½¬å½•å’ŒPDFå¤„ç†ï¼‰åœ¨åå°è¿è¡Œï¼Œæé«˜ç³»ç»Ÿå“åº”èƒ½åŠ›
""")

# å…³é”®ç—›ç‚¹ä¸å¹³å°ä»·å€¼
st.markdown("""
## å…³é”®ç—›ç‚¹ä¸å¹³å°ä»·å€¼

### è¡Œä¸šç—›ç‚¹

* **ç«äº‰æƒ…æŠ¥ç³»ç»Ÿæ€§ç¼ºå¤±**ï¼šæ— æ³•ç³»ç»Ÿæ€§è·å–æ¥è‡ªå¤–éƒ¨çš„ç«å“åˆ†æä¸ç”¨æˆ·åé¦ˆä¿¡æ¯ï¼Œç«äº‰æƒ…æŠ¥ä½“ç³»ä¸å®Œå–„
* **çŸ¥è¯†æ£€ç´¢ä½æ•ˆ**ï¼šå”®åã€ç ”å‘ã€è®¾è®¡ç­‰å›¢é˜Ÿåœ¨å¤šä¸ªç³»ç»Ÿä¸­æŸ¥æ‰¾PDFã€æ—¥å¿—ã€å†å²è®°å½•æ—¶æ•ˆç‡ä½ä¸‹ï¼ŒçŸ¥è¯†å¤ç”¨å›°éš¾
* **ç»éªŒä¾èµ–é—®é¢˜**ï¼šé—®é¢˜æ’æŸ¥è¿‡ç¨‹ä¸­é‡å¤ä¾èµ–èµ„æ·±äººå‘˜ç»éªŒï¼Œæ–‡æ¡£ä¸è§†é¢‘å†…å®¹ç»“æ„åŒ–ç¨‹åº¦ä½ï¼Œæ— æ³•å¿«é€Ÿå®šä½å…³é”®ä¿¡æ¯
* **å¤šæ¨¡æ€éšœç¢**ï¼šå¤šè¯­è¨€ã€è·¨æ¨¡æ€çš„æ•°æ®æŸ¥è¯¢ä¸ç»Ÿä¸€ï¼Œå¯¼è‡´æŸ¥è¯¢é“¾è·¯å†—é•¿ã€ç†è§£æˆæœ¬é«˜ï¼Œæ— æ³•å‘æŒ¥æ•°æ®æœ€å¤§ä»·å€¼

### å¹³å°ä»·å€¼

* **ç»Ÿä¸€è¯­ä¹‰å…¥å£**ï¼šæä¾›ç»Ÿä¸€è¯­ä¹‰æ£€ç´¢å…¥å£ï¼Œæ”¯æŒä¸­è‹±æ–‡ã€è§†é¢‘ã€æ–‡æ¡£ã€æ—¥å¿—ç­‰å†…å®¹çš„å¤šæ¨¡æ€æ™ºèƒ½é—®ç­”
* **è§†é¢‘å†…å®¹æ™ºèƒ½åŒ–**ï¼šè§†é¢‘å†…å®¹å¤„ç†æˆä¸ºæ ¸å¿ƒèƒ½åŠ›ï¼Œå¯å¿«é€Ÿæå–ç«å“å‘å¸ƒä¼šã€KOLè¯„ä»·ã€ç”¨æˆ·åé¦ˆç­‰å…³é”®ä¿¡æ¯
* **é™ä½ä¿¡æ¯é—¨æ§›**ï¼šå¤§å¹…é™ä½ä¿¡æ¯è·å–é—¨æ§›ï¼Œæ”¯æ’‘ç ”å‘ã€å”®åã€å“ç‰Œã€ç­–ç•¥å›¢é˜Ÿåšå‡ºæ›´å¿«ã€æ›´æœ‰ä¾æ®çš„åˆ¤æ–­
* **æ™ºèƒ½å¼•æ“èƒ½åŠ›**ï¼šä½œä¸ºåº•å±‚æ™ºèƒ½å¼•æ“åµŒå…¥å¹³å°ç³»ç»Ÿï¼Œä¸ºAI Agentã€å®¢æœæœºå™¨äººç­‰æ™ºèƒ½å·¥å…·æä¾›è¯­ä¹‰ç†è§£èƒ½åŠ›
""")

# å‰æ™¯å±•æœ›ä¸å‘å±•ç›®æ ‡
st.markdown("""
## å‰æ™¯å±•æœ›ä¸å‘å±•ç›®æ ‡

### ğŸ“ˆ èƒ½åŠ›å¤åˆ¶ä¸å¹³å°åŒ–å‘å±•
* RAG çŸ¥è¯†å¼•æ“å¯ä½œä¸º AI Agent æ„å»ºå¹³å°çš„æ ¸å¿ƒåº•åº§ï¼Œå‘æ›´å¤šéƒ¨é—¨å¤åˆ¶æ™ºèƒ½çŸ¥è¯†åº”ç”¨æ¨¡å¼
* è§†é¢‘æƒ…æŠ¥æå–èƒ½åŠ›å¯æ‰©å±•ä¸ºå“ç‰Œå¸‚åœºã€ç­–ç•¥ã€ç«å“åˆ†æç­‰è·¨éƒ¨é—¨æ™ºèƒ½è¾“å…¥ç³»ç»Ÿ
* é€šè¿‡æ ‡å‡†åŒ–æ¥å£ä¸æœåŠ¡ï¼Œå®ç°æŠ€æœ¯èƒ½åŠ›åœ¨ä¸åŒä¸šåŠ¡åœºæ™¯çš„å¿«é€Ÿéƒ¨ç½²ä¸å®šåˆ¶

### ğŸ‘¥ äººæ‰èµ‹èƒ½ä¸ç»„ç»‡è½¬å‹
* **äº§å“ç»ç†**ï¼šå¿«é€ŸæŒæ¡ç”¨æˆ·æ´å¯Ÿä¸ç³»ç»ŸåŒ–è®¾è®¡èƒ½åŠ›ï¼Œç»“åˆ AI èƒ½åŠ›å¢å¼º"ä»ä¸šåŠ¡ä¸­æç‚¼è§„åˆ™"çš„åˆ¤æ–­åŠ›
* **ä¼ä¸šå†…è®­**ï¼šæ‰¹é‡åŸ¹å…»å…·å¤‡äº§å“æ€ç»´ä¸ç³»ç»Ÿç†è§£çš„ä¸šåŠ¡è´Ÿè´£äººï¼Œæ¨åŠ¨"AI in workflow"çš„ç»„ç»‡æ¼”è¿›
* **å”®åä¸å·¥å‚**ï¼šç»“åˆè§„åˆ™å¼•æ“ä¸è¯­ä¹‰ç³»ç»Ÿï¼Œæ„å»º"è‡ªè§£é‡Šå‹æ•°æ®é—­ç¯"ï¼Œå‡è½»äººå·¥æŸ¥éªŒè´Ÿæ‹…

### ğŸ”„ æŒç»­è¿­ä»£ä¸ä¼˜åŒ–è·¯çº¿
* ä¸æ–­æ‰©å……æ›´å¤šæ±½è½¦é¢†åŸŸä¸“ä¸šæ•°æ®æºï¼Œæå‡ç³»ç»Ÿå›ç­”çš„ä¸“ä¸šæ€§ä¸å‡†ç¡®åº¦
* å¢å¼ºè·¨è¯­è¨€ç†è§£èƒ½åŠ›ï¼Œæ”¯æŒæ›´å¤šè¯­ç§çš„æ±½è½¦æŠ€æœ¯æ–‡æ¡£å¤„ç†
* æ¢ç´¢ä¸ç°æœ‰ä¸šåŠ¡ç³»ç»Ÿçš„æ·±åº¦é›†æˆï¼Œå®ç°ä»ä¿¡æ¯æ£€ç´¢åˆ°ä¸šåŠ¡å†³ç­–çš„é—­ç¯
""")

# åå°å¤„ç†ç³»ç»Ÿä»‹ç»
st.markdown("""
## åå°å¤„ç†ç³»ç»Ÿ

ç³»ç»Ÿç°åœ¨åŒ…å«ä¸€ä¸ªå¼ºå¤§çš„åå°å¤„ç†å­ç³»ç»Ÿï¼Œä¸“é—¨å¤„ç†èµ„æºå¯†é›†å‹ä»»åŠ¡ï¼š

### ä¸»è¦ç‰¹ç‚¹

- **éé˜»å¡å¤„ç†**ï¼šè§†é¢‘è½¬å½•å’ŒPDFå¤„ç†ç­‰é‡ä»»åŠ¡åœ¨åå°æ‰§è¡Œï¼ŒUIä¿æŒå“åº”
- **ä»»åŠ¡ç®¡ç†**ï¼šå®Œæ•´çš„ä»»åŠ¡ç®¡ç†ç•Œé¢ï¼Œè·Ÿè¸ªæ‰€æœ‰å¤„ç†ä»»åŠ¡çš„çŠ¶æ€
- **é«˜å¹¶å‘æ”¯æŒ**ï¼šåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº
- **è‡ªåŠ¨èµ„æºç®¡ç†**ï¼šä¼˜åŒ–CPUå’Œå†…å­˜ä½¿ç”¨ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½
- **ä»»åŠ¡æ¢å¤**ï¼šæ”¯æŒä»æ„å¤–ä¸­æ–­ä¸­æ¢å¤ä»»åŠ¡
- **ç³»ç»Ÿé€šçŸ¥**ï¼šé‡è¦äº‹ä»¶é€šçŸ¥ç³»ç»Ÿï¼ŒåŠæ—¶æé†’ç®¡ç†å‘˜å¤„ç†é—®é¢˜

### æ”¯æŒçš„åå°ä»»åŠ¡ç±»å‹

1. **è§†é¢‘å¤„ç†**ï¼šYouTubeå’ŒBilibiliè§†é¢‘çš„ä¸‹è½½å’Œè½¬å½•
2. **PDFå¤„ç†**ï¼šPDFè§£æã€OCRå’Œè¡¨æ ¼æå–
3. **æ‰¹é‡è§†é¢‘å¤„ç†**ï¼šä¸€æ¬¡å¤„ç†å¤šä¸ªè§†é¢‘é“¾æ¥

### å¦‚ä½•ä½¿ç”¨

1. æäº¤ä»»åŠ¡åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåå°ä½œä¸šå¹¶è·³è½¬åˆ°ä»»åŠ¡ç®¡ç†é¡µé¢
2. åœ¨ä»»åŠ¡ç®¡ç†é¡µé¢æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡çš„çŠ¶æ€å’Œç»“æœ
3. ç³»ç»Ÿé€šçŸ¥é¡µé¢å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç³»ç»Ÿè­¦å‘Šå’Œé”™è¯¯
""")

# è·å–ç³»ç»ŸçŠ¶æ€ä¿¡æ¯
try:
   status_info = api_request(
       endpoint="/ingest/status",
       method="GET"
   )

   if status_info:
       col1, col2 = st.columns(2)

       with col1:
           st.subheader("ç³»ç»ŸçŠ¶æ€")
           st.write(f"çŠ¶æ€: {status_info.get('status', 'æœªçŸ¥')}")
           document_count = status_info.get('document_count') or 0
           st.write(f"æ–‡æ¡£æ•°é‡: {document_count}")

           # æ˜¾ç¤ºé›†åˆä¿¡æ¯
           collection = status_info.get("collection") or 'æœªå®šä¹‰'
           st.write(f"é›†åˆ: {collection}")

           # æ˜¾ç¤ºä»»åŠ¡ç»Ÿè®¡
           if "job_stats" in status_info:
               job_stats = status_info.get("job_stats", {})
               st.subheader("åå°ä»»åŠ¡")

               col1a, col1b, col1c, col1d = st.columns(4)
               with col1a:
                   st.metric("ç­‰å¾…ä¸­", job_stats.get("pending_jobs", 0))
               with col1b:
                   st.metric("å¤„ç†ä¸­", job_stats.get("processing_jobs", 0))
               with col1c:
                   st.metric("å·²å®Œæˆ", job_stats.get("completed_jobs", 0))
               with col1d:
                   st.metric("å¤±è´¥", job_stats.get("failed_jobs", 0))

       with col2:
           st.subheader("æœåŠ¡çŠ¶æ€")

           # è·å–ç®€å•çš„æœåŠ¡çŠ¶æ€ä¿¡æ¯
           service_status = api_request(
               endpoint="/system/health/detailed",
               method="GET",
               silent=True
           )

           if service_status:
               # åˆ›å»ºä¸€ä¸ªç®€æ´çš„æœåŠ¡çŠ¶æ€æ‘˜è¦
               services = {
                   "API æœåŠ¡": "âœ… æ­£å¸¸",
                   "LLM æœåŠ¡": "âš ï¸ æœªçŸ¥",
                   "åµŒå…¥æœåŠ¡": "âš ï¸ æœªçŸ¥",
                   "è½¬å½•æœåŠ¡": "âš ï¸ æœªçŸ¥",
                   "æ–‡æœ¬å¤„ç†æœåŠ¡": "âš ï¸ æœªçŸ¥"
               }

               # ä»å¥åº·æ£€æŸ¥æ›´æ–°æœåŠ¡çŠ¶æ€
               workers = service_status.get("workers", {})
               for worker_id, info in workers.items():
                   worker_type = info.get("type", "unknown")
                   status = info.get("status", "unknown")

                   if "gpu-inference" in worker_type:
                       services["LLM æœåŠ¡"] = "âœ… æ­£å¸¸" if status == "healthy" else "âŒ å¼‚å¸¸"
                   elif "gpu-embedding" in worker_type:
                       services["åµŒå…¥æœåŠ¡"] = "âœ… æ­£å¸¸" if status == "healthy" else "âŒ å¼‚å¸¸"
                   elif "gpu-whisper" in worker_type:
                       services["è½¬å½•æœåŠ¡"] = "âœ… æ­£å¸¸" if status == "healthy" else "âŒ å¼‚å¸¸"
                   elif "cpu" in worker_type:
                       services["æ–‡æœ¬å¤„ç†æœåŠ¡"] = "âœ… æ­£å¸¸" if status == "healthy" else "âŒ å¼‚å¸¸"

               # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€è¡¨æ ¼
               for service, status in services.items():
                   st.text(f"{service}: {status}")

               # æ·»åŠ æŸ¥çœ‹è¯¦æƒ…é“¾æ¥
               st.markdown("[æŸ¥çœ‹è¯¦ç»†çŠ¶æ€](/ç³»ç»Ÿç®¡ç†)")

except Exception as e:
   st.error(f"è·å–ç³»ç»ŸçŠ¶æ€æ—¶å‡ºé”™: {str(e)}")
else:
   st.info("APIæœåŠ¡å¯ç”¨ï¼Œä½†æœªèƒ½è·å–ç³»ç»ŸçŠ¶æ€ã€‚è¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®ã€‚")